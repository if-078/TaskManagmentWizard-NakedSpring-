<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!--CSS-->
    <link rel="stylesheet" type="text/css" href="static/css/taskFilterStyle.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!--EasyUI-->
    <link rel="stylesheet" type="text/css" href="static/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="static/easyui/themes/icon.css">

    <!--Bootstrap data-table-->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css">
    <link href="static/css/mystyle.css" rel="stylesheet" type="text/css">

    <!--JS-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!--EasyUI-->
    <script type="text/javascript" src="static/easyui/jquery.min.js"></script>
    <script type="text/javascript" src="static/easyui/jquery.easyui.min.js"></script>


    <!--Other-->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>

    <!--JS data-table -->
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
</head>
<body>
<div style="padding-bottom: 10px;">
    <button type="button" id="delete-task" class="btn btn-danger btn-sm"> <span class="glyphicon glyphicon-remove"></span> delete task </button>
    <button type="button" id ="btn-modal-task" class="btn btn btn-info btn-sm" data-toggle="modal" data-target="#modal-new-task"><span class="glyphicon glyphicon-list-alt"></span> create task </button>
</div>

<table id="task-table"  class="table table-bordered" cellspacing="0" width="100%">
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>CreatedDate</th>
        <th>StartDate</th>
        <th>EndDate</th>
        <th>EstimateTime</th>
        <th>AssignTo</th>
        <th>StatusId</th>
        <th>PriorityId</th>
        <th>ParentId</th>
    </tr>
    </thead>
</table>

<!--MODAL WINDOW-->
<div class="modal fade" id="modal-new-task" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    Create/Update task
                </h4>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form class="form-horizontal" role="form">

                    <div class="form-group">
                        <label  class="col-sm-2 control-label"
                                for="input-name">Name</label>
                        <div class="col-sm-10">
                            <input type="name" class="form-control" id="input-name" placeholder="Name"/>
                            <div id="error-task-name"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label  class="col-sm-2 control-label"
                                for="input-createdDate">Created Date</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-createdDate"/>
                            <p id="error-task-input-createdDate"></p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"
                               for="input-startDate" >Start Date</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-startDate"/>
                            <div id="error-task-startDate"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"
                               for="input-estimateTime" >Estimate Time</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-estimateTime"/>
                            <div id="error-task-estimateTime"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"
                               for="input-endDate" >End Date</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-endDate"/>
                            <div id="error-task-endDate"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"
                               for="input-assignTo" >Assign To</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-assignTo"/>
                            <div id="error-task-assignTo"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label"
                               for="input-statusId" >Status Id</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-statusId"/>
                            <div id="error-task-statusId"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"
                               for="input-priorityId" >Priority Id</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-priorityId"/>
                            <div id="error-task-priorityId"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"
                               for="input-parentId" >Parent Id</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-parentId"/>
                            <div id="error-task-parentId"></div>
                        </div>
                    </div>

                </form>
            </div>
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal">
                    Close
                </button>
                <button type="button"  id="create-task" class="btn btn-success"> <span class="glyphicon glyphicon-ok"></span> Save </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        var task = {};
        var table = null;
        $('#btn-modal-task').click( function () {clearInputtask()});
        var url = 'tasks' //default URL
        initialTableOftasks(url);

        if(table != null){
            console.log("not null table");
            table.clear().draw();
        } else {
            console.log("table empty")
        }

        console.log("table no else")
    } );


    function initialTableOftasks(URL) {
        $.ajax({
            type: 'GET',
            url: URL,
            contentType: 'application/json',
            async: true,
            success: function(data) {
                if(table != null){
                    console.log("not null table");
                    table.clear().draw();
                } else {
                    console.log("table empty")
                }
                table = $('#task-table').DataTable({
                    "destroy": true,
                    "aaData": data,
                    "aoColumns": [
                        {"mDataProp":"id"},
                        {"mDataProp":"name"},
                        {"mDataProp":"createdDate"},
                        {"mDataProp":"startDate"},
                        {"mDataProp":"endDate"},
                        {"mDataProp":"estimateTime"},
                        {"mDataProp":"assignTo"},
                        {"mDataProp":"statusId"},
                        {"mDataProp":"priorityId"},
                        {"mDataProp":"parentId"},
                    ]
                });
                // delete task and row
                $('#task-table tbody').on( 'click', 'tr', function () {
                    if ( $(this).hasClass('selected') ) {
                        $(this).removeClass('selected');
                    }
                    else {
                        table.$('tr.selected').removeClass('selected');
                        $(this).addClass('selected');
                        $(this).addClass('active').siblings().removeClass('active');
                    }
                } );
                $('#delete-task').on("click", function () {
                    var taskId = $('tr.selected td:first-child').text();
                    console.log("-================");
                    console.log(taskId);
                    console.log("-================");

                    deletetask(taskId);
                    table.row('.selected').remove().draw( false );
                } );
                // update task and row
                $('#task-table tbody').on( 'dblclick', 'tr', function () {
                    $(this).addClass("selected").siblings().removeClass("selected");
                    task={};
                    task = table.row( this ).data();
                    var taskId = $('tr.selected td:first-child').text();
                    //fill data
                    $('#input-name').val(task.name);
                    $('#input-createdDate').val(task.createdDate);
                    $('#input-startDate').val(task.startDate);
                    $('#input-endDate').val(task.endDate);
                    $('#input-estimateTime').val(task.estimateTime);
                    $('#input-assignTo').val(task.assignTo);
                    $('#input-statusId').val(task.statusId);
                    $('#input-priorityId').val(task.priorityId);
                    $('#input-parentId').val(task.parentId);
                    // open modal window
                    $('#modal-new-task').modal('show');
                } );
                $('#create-task').on( 'click',function () {
                    createOrUpdatetask(table, window.task);
                } );
            },
            error: function(jqXHR) {
                console.log(jqXHR.status)
            }
        });
    }
    function deletetask(taskId){
        $.ajax({
            type: 'DELETE',
            url: 'tasks/' + taskId,
            contentType: 'application/json',
            error: function(jqXHR) {
                console.log(jqXHR.status)
            }
        });
    }
    function createOrUpdatetask(table, task){
        if ($.isEmptyObject(task)) {
            task =
            {
                "name":$('#input-name').val(),
                "createdDate":$('#input-createdDate').val(),
                "startDate":$('#input-startDate').val(),
                "endDate":$('#input-endDate').val(),
                "estimateTime":$('#input-estimateTime').val(),
                "assignTo":$('#input-assignTo').val(),
                "statusId":$('#input-statusId').val(),
                "priorityId":$('#input-priorityId').val(),
                "parentId":$('#input-parentId').val()
            }
            createtask(table, task);
        }else{
            task.name = $('#input-name').val(),
            task.createdDate= $('#input-createdDate').val(),
            task.startDate= $('#input-startDate').val(),
            task.endDate= $('#input-endDate').val(),
            task.estimateTime= $('#input-estimateTime').val(),
            task.assignTo= $('#input-assignTo').val(),
            task.statusId= $('#input-statusId').val(),
            task.priorityId= $('#input-priorityId').val(),
            task.parentId= $('#input-parentId').val()
            updatetask(table, task);
        }
    }
    function createtask(table, task){
        $.ajax({
            url: 'tasks',
            data: JSON.stringify(task),
            type: 'POST',
            contentType: 'application/json',
            success: function (data) {
                // add row to table
                table.row.add( {
                    "id":data.id,
                    "name":data.name,
                    "createdDate":data.createdDate,
                    "startDate":data.startDate,
                    "endDate":data.endDate,
                    "estimateTime":data.estimateTime,
                    "assignTo":data.assignTo,
                    "statusId":data.statusId,
                    "priorityId":data.priorityId,
                    "parentId":data.parentId
                } ).draw();
                $('#modal-new-task').modal('hide');
                clearInputtask();
            },
            cache: false
        }).fail(function ($xhr) {
            if($xhr.status == 400){
                var data = $xhr.responseJSON;
            }
        });
    }
    function updatetask(table, task){
        $.ajax({
            url: 'tasks',
            data: JSON.stringify(task),
            type: 'PUT',
            contentType: 'application/json',
            success: function () {
                // update row of table
                table.row('.selected').data(task).draw();
                $('#modal-new-task').modal('hide');
                clearInputtask();
            },
            cache: false
        }).fail(function ($xhr) {
            if($xhr.status == 400){
                var data = $xhr.responseJSON;
            }
        });
    }
    function clearInputtask(){
        $('#input-name').val(''),
                $('#input-createdDate').val(''),
                $('#input-startDate').val(''),
                $('#input-endDate').val(''),
                $('#input-estimateTime').val(''),
                $('#input-assignTo').val(''),
                $('#input-statusId').val(''),
                $('#input-priorityId').val(''),
                $('#input-parentId').val('')
    }
</script>
</body>
</html>