<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
</head>
<body>
<div style="padding-bottom: 10px;">
    <button type="button" id="delete-task" class="btn btn-danger btn-sm"> delete task </button>
    <button type="button" id ="btn-modal-task" class="btn btn btn-info btn-sm" data-toggle="modal" data-target="#modal-new-task"> create task </button>
</div>

<table id="task-table" class="table table-striped">
    <thead class="thead-inverse">
    <tr>
        <th>#</th>
        <th>ID</th>
        <th>Name</th>
        <th>CreatedDate</th>
        <th>StartDate</th>
        <th>EndDate</th>
        <th>EstimateTime</th>
        <th>AssignTo</th>
        <th>StatusId</th>
        <th>PriorityId</th>
        <th>ParentId</th>
    </tr>
    </thead>
    <tbody id ="task-table-body"></tbody>
</table>

<!--MODAL WINDOW-->
<div class="modal fade" id="modal-new-task" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    Create/Update task
                </h4>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form class="form-horizontal" role="form">

                    <div class="form-group">
                        <label  class="col-sm-4 control-label" for="input-name">Name</label>
                        <div class="col-sm-10">
                            <input type="name" class="form-control" id="input-name" placeholder="Name"/>
                            <div id="error-task-name"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label  class="col-sm-6 control-label" for="input-createdDate">Created Date</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-createdDate"/>
                            <p id="error-task-input-createdDate"></p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-6 control-label"
                               for="input-startDate" >Start Date</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-startDate"/>
                            <div id="error-task-startDate"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-6 control-label"
                               for="input-estimateTime" >Estimate Time</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-estimateTime"/>
                            <div id="error-task-estimateTime"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-6 control-label"
                               for="input-endDate" >End Date</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-endDate"/>
                            <div id="error-task-endDate"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-6 control-label"
                               for="input-assignTo" >Assign To</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-assignTo"/>
                            <div id="error-task-assignTo"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-6 control-label"
                               for="input-statusId" >Status Id</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-statusId"/>
                            <div id="error-task-statusId"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-6 control-label"
                               for="input-priorityId" >Priority Id</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-priorityId"/>
                            <div id="error-task-priorityId"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-6 control-label"
                               for="input-parentId" >Parent Id</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="input-parentId"/>
                            <div id="error-task-parentId"></div>
                        </div>
                    </div>

                </form>
            </div>
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button"  id="create-task" class="btn btn-success"> Save </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var task = {};
    $('#btn-modal-task').on('click', function(){clearInputtask()});

    function initialTableOftasks(URL) {
        $("#task-table-body").empty();
        $.ajax({
            type: 'GET',
            url: URL,
            contentType: 'application/json',
            success: function(data) {
                $(function() {
                    $.each(data, function(i, task) {
                        var $tr = $('<tr>').append(
                                $('<th scope="row">').text(i + 1),
                                $('<td>').text(task.id),
                                $('<td>').text(task.name),
                                $('<td>').text(task.createdDate),
                                $('<td>').text(task.startDate),
                                $('<td>').text(task.endDate),
                                $('<td>').text(task.estimateTime),
                                $('<td>').text(task.assignTo),
                                $('<td>').text(task.statusId),
                                $('<td>').text(task.priorityId),
                                $('<td>').text(task.parentId))
                                .appendTo('#task-table-body');
                    });
                });
            }
        });
    }

    $('#task-table tbody').on( 'click', 'tr', function () {
        $(this).addClass('active').siblings().removeClass('active');
        $(this).css('background-color', 'powderblue').siblings().css('background-color', '');
    } );

    $('#delete-task').on("click", function () {
        var taskId = $('tr.active td:first').text();

        $('tr.active').remove();

        deletetask(taskId);
    } );

    $('#create-task').on( 'click',function () {
        createOrUpdatetask(task);
    } );

    // update task and row
    $('#task-table tbody').on( 'dblclick', 'tr', function () {
        $(this).addClass('active').siblings().removeClass('active');
        $(this).css('background-color', 'powderblue').siblings().css('background-color', '');
        task={};

        //create json of task
        task.id           = $('tr.active').children('td:eq(0)').text(),
        task.name         = $('tr.active').children('td:eq(1)').text(),
        task.createdDate  = $('tr.active').children('td:eq(2)').text(),
        task.startDate    = $('tr.active').children('td:eq(3)').text(),
        task.endDate      = $('tr.active').children('td:eq(4)').text(),
        task.estimateTime = $('tr.active').children('td:eq(5)').text(),
        task.assignTo     = $('tr.active').children('td:eq(6)').text(),
        task.statusId     = $('tr.active').children('td:eq(7)').text(),
        task.priorityId   = $('tr.active').children('td:eq(8)').text(),
        task.parentId     = $('tr.active').children('td:eq(9)').text()

        var taskId = $('tr.active td:first').text();
        //fill data
        $('#input-name').val(task.name);
        $('#input-createdDate').val(task.createdDate);
        $('#input-startDate').val(task.startDate);
        $('#input-endDate').val(task.endDate);
        $('#input-estimateTime').val(task.estimateTime);
        $('#input-assignTo').val(task.assignTo);
        $('#input-statusId').val(task.statusId);
        $('#input-priorityId').val(task.priorityId);
        $('#input-parentId').val(task.parentId);
        // open modal window
        $('#modal-new-task').modal('show');
    } );

    function deletetask(taskId){
        $.ajax({
            type: 'DELETE',
            url: 'tasks/' + taskId,
            contentType: 'application/json',
            error: function(jqXHR) {
                console.log(jqXHR.status)
            }
        });
    }

    function createOrUpdatetask(task){
        if ($.isEmptyObject(task)) {
            task =
            {
                "name"         :$('#input-name').val(),
                "createdDate"  :$('#input-createdDate').val(),
                "startDate"    :$('#input-startDate').val(),
                "endDate"      :$('#input-endDate').val(),
                "estimateTime" :$('#input-estimateTime').val(),
                "assignTo"     :$('#input-assignTo').val(),
                "statusId"     :$('#input-statusId').val(),
                "priorityId"   :$('#input-priorityId').val(),
                "parentId"     :$('#input-parentId').val()
            }
            createtask(task);
        }else{
            task.name         = $('#input-name').val(),
            task.createdDate  = $('#input-createdDate').val(),
            task.startDate    = $('#input-startDate').val(),
            task.endDate      = $('#input-endDate').val(),
            task.estimateTime = $('#input-estimateTime').val(),
            task.assignTo     = $('#input-assignTo').val(),
            task.statusId     = $('#input-statusId').val(),
            task.priorityId   = $('#input-priorityId').val(),
            task.parentId     = $('#input-parentId').val()

            updatetask(task);
        }
    }

    function createtask(task){
        $.ajax({
            url: 'tasks',
            data: JSON.stringify(task),
            type: 'POST',
            contentType: 'application/json',
            success: function (data) {

                // add row to table
                var $tr = $('<tr>').append(
                        $('<th scope="row">').text('new'),
                        $('<td>').text(data.id),
                        $('<td>').text(data.name),
                        $('<td>').text(data.createdDate),
                        $('<td>').text(data.startDate),
                        $('<td>').text(data.endDate),
                        $('<td>').text(data.estimateTime),
                        $('<td>').text(data.assignTo),
                        $('<td>').text(data.statusId),
                        $('<td>').text(data.priorityId),
                        $('<td>').text(data.parentId))
                        .appendTo('#task-table-body');

                $('#modal-new-task').modal('hide');

                clearInputtask();
            },
            cache: false
        }).fail(function ($xhr) {
            if($xhr.status == 400){
                var data = $xhr.responseJSON;
            }
        });
    }
    function updatetask(task){
        $.ajax({
            url: 'tasks',
            data: JSON.stringify(task),
            type: 'PUT',
            contentType: 'application/json',
            success: function () {
                // update row of table
                $('tr.active').children('td:eq(0)').text(task.id),
                $('tr.active').children('td:eq(1)').text(task.name),
                $('tr.active').children('td:eq(2)').text(task.createdDate),
                $('tr.active').children('td:eq(3)').text(task.startDate),
                $('tr.active').children('td:eq(4)').text(task.endDate),
                $('tr.active').children('td:eq(5)').text(task.estimateTime),
                $('tr.active').children('td:eq(6)').text(task.assignTo),
                $('tr.active').children('td:eq(7)').text(task.statusId),
                $('tr.active').children('td:eq(8)').text(task.priorityId),
                $('tr.active').children('td:eq(9)').text(task.parentId);

                $('#modal-new-task').modal('hide');

                clearInputtask();
            },
            cache: false
        }).fail(function ($xhr) {
            if($xhr.status == 400){
                var data = $xhr.responseJSON;
            }
        });
    };

    function clearInputtask(){
        $('#input-name').val(''),
        $('#input-createdDate').val(''),
        $('#input-startDate').val(''),
        $('#input-endDate').val(''),
        $('#input-estimateTime').val(''),
        $('#input-assignTo').val(''),
        $('#input-statusId').val(''),
        $('#input-priorityId').val(''),
        $('#input-parentId').val('')
    }
</script>
</body>
</html>